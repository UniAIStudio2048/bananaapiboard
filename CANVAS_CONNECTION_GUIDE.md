# 🔗 画布节点连线功能指南

## 功能概述

画布中的节点连线功能现在支持智能化的交互流程，让创作者能够快速构建工作流。

---

## ✨ 核心特性

### 1️⃣ **拖拽连线自动显示节点选择器**

当你从节点拖出连线并松开时，系统会自动弹出节点选择器，让你选择要连接的目标节点类型。

**操作流程：**
```
从节点端口拖出连线 → 松开鼠标 → 自动显示节点选择器 → 点击选择节点 → 自动创建并连接
```

**支持两种拖拽方式：**
- **从端口拖拽**：从节点左侧/右侧的圆形端口拖出连线
- **从 + 按钮拖拽**：从节点右上角的 `+` 按钮拖出连线

### 2️⃣ **智能节点筛选**

节点选择器会根据源节点类型，自动筛选出可以连接的目标节点类型。

**示例：**
- **文本节点** → 可连接：图片生成、视频生成、LLM节点
- **图片节点** → 可连接：图生图、图生视频、图片编辑
- **LLM节点** → 可连接：图片生成、视频生成

### 3️⃣ **点击空白画布取消连线**

如果你不想连接任何节点，只需点击画布的空白区域，即可取消连线操作。

**操作流程：**
```
拖出连线 → 松开（显示节点选择器）→ 点击空白画布 → 取消连线
```

### 4️⃣ **按 ESC 键取消连线**

在任何连线过程中，按下 `Esc` 键都可以立即取消连线操作。

**支持的场景：**
- ✅ 正在拖拽连线时（连线还在手中）
- ✅ 节点选择器已显示时（选择器会关闭）
- ✅ 从 `+` 按钮拖拽连线时
- ✅ 从端口拖拽连线时

---

## 🎯 完整交互流程

### 场景 1：成功连接到新节点

```
1. 从节点A拖出连线
2. 松开鼠标
3. 自动显示节点选择器
4. 点击"图片生成"节点
5. 系统自动创建图片生成节点并连接到节点A
```

### 场景 2：拖拽时按ESC取消

```
1. 从节点A拖出连线
2. 正在拖拽中...
3. 按下 Esc 键
4. 连线立即取消，不显示节点选择器
```

### 场景 3：选择器显示后取消

```
1. 从节点A拖出连线
2. 松开鼠标
3. 自动显示节点选择器
4. 按下 Esc 键 或 点击空白画布
5. 节点选择器关闭，连线取消
```

### 场景 4：直接连接到现有节点

```
1. 从节点A拖出连线
2. 拖拽到节点B的输入端口
3. 松开鼠标
4. 系统自动连接节点A和节点B（不显示选择器）
```

---

## 🔧 技术实现细节

### 连线状态管理

系统维护两种连线状态：

1. **isDraggingConnection** - 从 `+` 按钮拖拽的连线状态
2. **isVueFlowConnecting** - 从端口拖拽的原生连线状态

### ESC 键优先级处理

按下 `Esc` 键时，系统按以下优先级处理：

```
1. 如果正在拖拽连线（+ 按钮） → 取消拖拽
2. 如果正在使用原生连线（端口） → 取消连线
3. 如果节点选择器打开 → 关闭选择器
4. 如果右键菜单打开 → 关闭菜单
5. 其他情况 → 取消选择
```

### 节点选择器自动连接

当用户在节点选择器中选择节点时：

1. 系统根据 `triggerNodeId` 创建新节点
2. 自动添加从源节点到新节点的连线
3. 新节点位置智能放置在鼠标位置
4. 连线完成后选中新节点

---

## 🎨 视觉反馈

### 连线拖拽中
- 显示蓝色虚线连线
- 连线末端跟随鼠标移动
- 连线带有箭头指示方向

### 节点选择器
- 半透明深色背景面板
- 显示所有可连接的节点类型
- 带有图标和描述信息
- 鼠标悬停高亮效果

### 取消连线
- 连线立即消失
- 节点选择器淡出关闭
- 无任何副作用

---

## 💡 用户体验优化

### 智能位置计算
- 新节点自动放置在鼠标位置附近
- 节点中心对齐鼠标点击位置
- 避免节点重叠

### 防误操作
- 点击节点选择器面板不会关闭面板
- 连线拖拽到空白处才显示选择器
- ESC键随时可取消操作

### 日志记录
系统会在控制台输出连线操作日志：
- `[Canvas] 开始连线拖拽`
- `[Canvas] 连线拖拽到空白处，打开节点选择器`
- `[Canvas] 用户按ESC取消连线拖拽`
- `[Canvas] 用户点击空白画布，取消连线选择`
- `[Canvas] 连线成功: node-xxx -> node-yyy`

---

## 🔍 调试提示

如果连线功能出现问题，检查以下几点：

1. **节点类型兼容性** - 确保源节点和目标节点类型兼容（参考 `nodeTypes.js` 中的 `CONNECTION_RULES`）
2. **端口配置** - 确保节点有正确的输入/输出端口
3. **Store 状态** - 检查 `triggerNodeId` 和 `nodeSelectorFlowPosition` 是否正确设置
4. **控制台日志** - 查看连线操作的详细日志

---

## 📝 代码位置

**主要文件：**
- `src/components/canvas/CanvasBoard.vue` - 连线逻辑实现
- `src/components/canvas/NodeSelector.vue` - 节点选择器
- `src/stores/canvas/canvasStore.js` - 状态管理
- `src/config/canvas/nodeTypes.js` - 节点类型和连接规则

**关键函数：**
- `onConnectStart()` - 连线开始
- `onConnectEnd()` - 连线结束
- `handleDragConnectionEnd()` - 拖拽连线结束
- `cancelDragConnection()` - 取消拖拽连线
- `cancelVueFlowConnection()` - 取消原生连线
- `handleKeyDown()` - 键盘事件处理

---

## 🎉 总结

现在画布的连线功能已经非常智能和友好：

✅ **拖出连线 → 自动显示选择器**  
✅ **点击选择 → 自动创建并连接**  
✅ **点击空白 → 取消连线**  
✅ **按 ESC → 随时取消**  

这些改进让创作者能够更快速、更流畅地构建工作流！🚀

